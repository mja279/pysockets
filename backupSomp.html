<html>
  <head>
    <link rel="stylesheet" href="./style.css">
  </head>

    <body>
        <p>This example shows you the contents of the selected part of your display.
        Click the Start Capture button to begin.</p>
        <p><button id="start">Start Capture</button>&nbsp;<button id="stop">Stop Capture</button></p><p><button id="accept">Accept Stream</button>
        <div class="videos">
          <span>
            <h3>Local</h3>
            <video id="video" controls autoplay playsisline></video>
          </span>

          <span>
            <h3>Remote</h3>
            <video id="remote" controls autoplay playsisline></video>
          </span>
        </div>
        <strong>Log:</strong>
        <br>
        <pre id="log"></pre>
        
        <script>
          const videoElem = document.getElementById("video");
          const remoteElem = document.getElementById("remote");
          const logElem = document.getElementById("log");
          const startElem = document.getElementById("start");
          const acceptElem = document.getElementById("accept");
          const stopElem = document.getElementById("stop");
          
          var isSharing = false;
          var seshDescSet = false;
          var systemicRacism = 0;
          var institutionalBias = 0; 
          var offerICE;

          var remoteStream = null;
          
          //const servers = {
          //  iceServers: [
          //    {
          //      urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'],
          //    },
          //  ],
          //  iceCandidatePoolSize: 10,
          //};

          var pc = null;

          //const pc = new RTCPeerConnection(servers);
          //const pc = new RTCPeerConnection();
          
          var boolSet = false;
          
          var stuff;
          
          var displayMediaOptions = {
            video: {
              cursor: "always"
            },
            audio: true
          };

          window.onload = function() {
            //var socket = new WebSocket("ws://ec2-52-0-207-17.compute-1.amazonaws.com:5678/");    
            var socket = new WebSocket("ws://127.0.0.1:5678/");    
            
            async function createPeerConnection() {
              //log("Setting up a connection...");
            
              // Create an RTCPeerConnection which knows to use our chosen
              // STUN server.
            
              const servers = {
                iceServers: [
                  {
                    urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'],
                  },
                ],
                iceCandidatePoolSize: 10,
              };
            
              pc = new RTCPeerConnection(servers);
              // Set up event handlers for the ICE negotiation process.
            
              pc.onnegotiationneeded = function() {
                pc.createOffer().then(function(offer) {
                  return pc.setLocalDescription(offer);
                })
                .then(function() {
                  socket.send(JSON.stringify({
                    name: "local",
                    type: "video-offer",
                    sdp: pc.localDescription
                  }));
                })
                .catch("error de abrto");
              };

              pc.onicecandidate = e => 
                //if(e.candidate) {
                    socket.send(JSON.stringify({
                        type: "new-ice-candidate",
                        candidate: e.candidate
                    }));
                //}

              pc.ontrack = ev => {
                if (ev.streams && ev.streams[0]) {
                  remoteElem.srcObject = ev.streams[0];
                } else {
                  if (!remoteStream) {
                    remoteStream = new MediaStream();
                    remoteElem.srcObject = remoteStream;
                  }
                  remoteStream.addTrack(ev.track);
                }
              };
            }

            //pc.ontrack = ev => {
            //  if (ev.streams && ev.streams[0]) {
            //    remoteElem.srcObject = ev.streams[0];
            //  } else {
            //    if (!remoteStream) {
            //      remoteStream = new MediaStream();
            //      remoteElem.srcObject = remoteStream;
            //    }
            //    remoteStream.addTrack(ev.track);
            //  }
            //};

            //             -.
            //               -._ . -.-. -.
            //              _._ -..   .--.  .
            //           .-'   '-.  -|\/    \|   -.
            //         .'         '-.\   (o)O) -.
            //        /         /         _.--.\ '. -. -.
            //       /|    (    |  /  -. ( -._( -._ '. '.
            //      /  \    \-.__\ \_.-'..__'.   -, '. .'
            //      |  /\    |  / \ \     --')/  .-'.'.'
            //  .._/  /  /  /  / / \ \          .' . .' .'
            // /  ___/  |  /   \ \  \ \__       '.'. . .
            // \  \___  \ (     \ \  . .     .' . ' .'
            //  \ -.\ (  -.__ | \    )//   .'  .' .-'
            //   \_-._\  \  -.)//    "".-' .-' .' .'
            //     `-'    \ -.\ ""..--''  .-' .'
            //             /    .' .-'.-'  .-' .-'
            //                 .-'.' .'  .' .-'
            ///////////////////////////////

            async function startCapture() {
              systemicRacism = 0; 
              logElem.innerHTML = "";
              isSharing = true;
              boolSet = false;
              
              if(boolSet == false) {
                if(!pc) {
                  createPeerConnection();
                }

                try {
                  localStream = videoElem.srcObject = await navigator.mediaDevices.getDisplayMedia(displayMediaOptions);
                  
                  localStream.getTracks().forEach((track) => {
                    pc.addTrack(track);
                  });
                  
                  console.log("LOCAL SET!!!");
                  
                  dumpOptionsInfo();
                } catch(err) {
                  console.error("Error: " + err);
                };
              };
            };
                        //// 
                      ////
                    ////////
                //////////////////
            ////////////////////////// 
                      // __▒▒▒▒▒
                      // —-▒▒▒▒▒▒▒▒▒
                      // —–▓▓▓░░▓░
                      // —▓░▓░░░▓░░░
                      // —▓░▓▓░░░▓░░░
                      // —▓▓░░░░▓▓▓▓
                      // ——░░░░░░░░
                      // —-▓▓▒▓▓▓▒▓▓
                      // –▓▓▓▒▓▓▓▒▓▓▓
                      // ▓▓▓▓▒▒▒▒▒▓▓▓▓
                      // ░░▓▒░▒▒▒░▒▓░░
                      // ░░░▒▒▒▒▒▒▒░░░
                      // ░░▒▒▒▒▒▒▒▒▒░░
                      // —-▒▒▒ ——▒▒▒
                      // –▓▓▓———-▓▓▓
                      // ▓▓▓▓———-▓▓▓▓
            ////////////////////////////////////

            socket.onmessage = function (evt) {
              if(!pc) {
                createPeerConnection();
              }
              msg = JSON.parse(evt.data);
              systemicRacism += 1;
              institutionalBias += 1;
              console.log(isSharing);

              if(evt.data == "STOPPED") {
                stopRemoteCapture();
              };

              if(msg.name == "local" && !isSharing) {
                  stuff = evt.data;

                  var remoteStream = null;
                
                
                  var desc = new RTCSessionDescription(JSON.parse(stuff).sdp);
                
                  //pc.setRemoteDescription(desc).then(function () {
                  //  return navigator.mediaDevices.getDisplayMedia(displayMediaOptions);
                  //})
                  pc.setRemoteDescription(desc).then(function(stream) {
                    //remoteStream = stream;
                    remoteElem.srcObject = remoteStream;
                
                    //localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
                  })
                  .then(function() {
                    return pc.createAnswer();
                  })
                  .then(function(answer) {
                    return pc.setLocalDescription(answer);
                  })
                  .then(function() {
                    var message = {
                      name: "remote",
                      type: "video-answer",
                      sdp: pc.localDescription
                    };
                
                    socket.send(message);
                  })
                  .catch("ERROR");
              };
              if(msg.type == "new-ice-candidate") {
                var candidate = new RTCIceCandidate(msg.candidate);

                pc.addIceCandidate(candidate)
                  .catch("ICE ERROR");
              }

              if(systemicRacism == 4) {
                boolSet = true;
              };

              if(msg.name == "remote" && isSharing && pc.remoteDescription == null) {
                stuff = evt.data;
                console.log("in isSharing Block")
                console.log("stuff: " + stuff);
                
                pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(stuff).sdp));
                seshDescSet = true;
              };
            };

            // .,--.
            // .'   \
            // | ..  |
            // |{)(} .'
            // / /|  |.
            // (/ /__)
            //   |||
            //     /'
            //     //
            //   .'''\
            // /:::/\
            // ( /|::|\
            // :|;;|{/
            // '.;|**|;,/
            //   _ /
            //   | 
            //   | 
            //   | 
            //   | 
            // .| ||.
            // ;,.-._,;
            ///////////

            startElem.addEventListener("click", function(evt) {
              startCapture();
            }, false);
            
            stopElem.addEventListener("click", function(evt) {
              stopCapture();
            }, false);

            acceptElem.addEventListener("click", function(evt) {
              acceptStream();
            }, false);
  
            console.log = msg => logElem.innerHTML += `${msg}<br>`;
            console.error = msg => logElem.innerHTML += `<span class="error">${msg}</span><br>`;
            console.warn = msg => logElem.innerHTML += `<span class="warn">${msg}<span><br>`;
            console.info = msg => logElem.innerHTML += `<span class="info">${msg}</span><br>`;
  
            function stopCapture(evt) {
              let tracks = videoElem.srcObject.getTracks();
              
              tracks.forEach(track => track.stop());
              videoElem.srcObject = null;
              boolSet = false;
              socket.send("STOPPED");
            };

            function stopRemoteCapture(evt) {
              let tracks = remoteElem.srcObject.getTracks();
              
              tracks.forEach(track => {
                  track.stop();
                  remoteStream.removeTrack(track);
              });
              remoteElem.srcObject = null;
              systemicRacism = 0;
              boolSet = false;
              institutionalBias = 0;
            };
  
            function dumpOptionsInfo() {
              const videoTrack = videoElem.srcObject.getVideoTracks()[0];
              
              console.info("Track settings:");
              console.info(JSON.stringify(videoTrack.getSettings(), null, 2));
              console.info("Track constraints:");
              console.info(JSON.stringify(videoTrack.getConstraints(), null, 2));
            }
          }
        </script>
    </body>
</html>
