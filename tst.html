<html>
    <head>
        <link rel="stylesheet" href="./style.css">
    </head>

    <body>
        <p>This example shows you the contents of the selected part of your display.
        Click the Start Capture button to begin.</p>
        
        <p><button id="start">Start Capture</button>&nbsp;<button id="stop">Stop Capture</button></p>
        
        <!-- <video id="video" autoplay></video>
        <br>
        <video id="remote" autoplay></video> -->
        
        <div class="videos">

          <span>
            <h3>Local</h3>
            <video id="video" controls autoplay playsisline></video>
          </span>

          <span>
            <h3>Remote</h3>
            <video id="remote" controls autoplay playsisline></video>
          </span>

        </div>

        <button class="open-button" onclick="openForm()">Chat</button>

        <div class="chat-popup" id="myForm">
          <form action="/action_page.php" class="form-container">
            <h1>Chat</h1>
        
            <label for="msg"><b>Message</b></label>
            <textarea placeholder="Type message.." name="msg" required></textarea>
        
            <button type="submit" class="btn">Send</button>
            <button type="button" class="btn cancel" onclick="closeForm()">Close</button>
          </form>
        </div>

        <strong>Log:</strong>
        <br>
        <pre id="log"></pre>

        <script>

          var socket = new WebSocket("ws://127.0.0.1:5678/");
          // explore: instant websock, and on open do all that stuff.
          var count = 0;

          var isLocal = false;

          var offer;
          // need to await, answer from remote client - on message
          var answer;
          var rc;
          var lc;
          var dc;
          var data;

            socket.onmessage = function(event) {
              data = JSON.parse(event.data);

              // await offer form host peer
              
              if(!isLocal && data.type == "video-offer") {

                offer = data.sdp;

                rc = new RTCPeerConnection();
  
                rc.onicecandidate = e => socket.send(JSON.stringify({
                  name: "remote",
                  type: "video-answer",
                  sdp: rc.localDescription
                }));
  
                rc.ondatachannel = e => {
                  rc.dc = e.channel;
                  rc.dc.onmessage = e => console.log("new message: " + e.data);
                  rc.dc.onopen = e => console.log("connected");
                };
  
                rc.setRemoteDescription(offer).then(a => console.log("offer set"));
  
                // should fire off onicecandidates where we can send a message to pass the description to the hosting client
                rc.createAnswer().then(a => rc.setLocalDescription(a)).then(a => console.log("answer created"));

                // rc.dc.send("fine what about u fam");
              }else if(isLocal && data.type == "video-answer") {
                // need to await, answer from remote client - on message
                answer = data.sdp;

                lc.setRemoteDescription(answer);
                // dc.send("yo peer b")
              }
            };

            socket.onopen = function(event) {
              
              isLocal = true;

              const lc = new RTCPeerConnection();
              const dc = lc.createDataChannel("channel");
              dc.onmessage = e => console.log("Just got a message " + e.data);
              dc.onopen = e => console.log("connection open");
              lc.onicecandidate = e => socket.send(JSON.stringify({
                name: "local",
                type: "video-offer",
                sdp: lc.localDescription
              }));

              // should fire off onicecandidates where we can send a message to pass the description to the remote client
              lc.createOffer().then(o => lc.setLocalDescription(o)).then(a => console.log("set succesfully"));
            };

            // Broken
            // const lc = new RTCPeerConnection();
            // const dc = lc.createDataChannel("channel");
            // dc.onmessage = e => console.log("Just got a message " + e.data);
            // dc.onopen = e => console.log("connection open");
            // lc.createOffer().then( o => lc.setLocalDescription(o)).then(a => console.log("set succesfully: " + JSON.stringify(lc.localDescription)));
            
            
            
            // Broken
            // const rc = new RTCPeerConnection();
            // rc.ondatachannel = e => {
            //     rc.dc = e.channel;
            //     rc.dc.onmessage = e => console.log("new message: " + e.data);
            //     rc.dc.onopen = e => console.log("connected");
            // };
            // rc.setRemoteDescription(offer).then(a => console.log("offer set"));
            // rc.createAnswer().then(a => rc.setLocalDescription(a)).then(a => console.log("answer created" + JSON.stringify(rc.localDescription)));
        </script>
    </body>
</html>

